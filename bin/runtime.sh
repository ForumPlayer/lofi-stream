#!/bin/bash

function configs(){
###############################################################################################################################################

    scale="${scale:-"1280:720"}"
    #scale="${scale:-"852:480"}"
    fps="${fps:-15}"
    
    

    OutputURL="${OutputURL:-"rtmp://live.twitch.tv/app"}"
    
    #OutputKey=""

    if [[ $dev == "yes" || $dev == "true" ]]; then OutputURL="rtmp://live.restream.io/live"; fi
    if [[ $fifo == "yes" || $fifo == "true" ]]; then AudioSourceURI="/tmp/mpd.fifo"; AudioFormat="s16le"; fi

    
###############################################################################################################################################
}



function checkdeps(){
###############################################################################################################################################
    fail="no"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    if [ ! -n "$(which ffmpeg)" ]; then echo "FFmpeg is not installed!"; fail="yes"; fi
    if [ ! -n "$(which mpd)" ]; then echo "MPD is not installed!"; fail="yes"; fi
    if [ ! -n "$(which mpc)" ]; then echo "MPC is not installed!"; fail="yes"; fi
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    if [ $fail == "yes" ]; then echo "Can't start streaming"; exit 1; fi
###############################################################################################################################################
}

function setup-stream() {
###############################################################################################################################################
    configs
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    gop=$((fps*2))
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    VideoSourceURI="${VideoSourceURI:-"$(realpath background.gif)"}"
    AudioSourceURI="${AudioSourceURI:-"http://127.0.0.1:4887"}"
    OverlaySourceURI="${OverlaySourceURI:-"$(realpath "$data/OverlayText.txt")"}"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    VideoFormat="${VideoFormat:-"gif"}"
    AudioFormat="${AudioFormat:-"ogg"}"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    VideoSource="-re -f $VideoFormat -i $VideoSourceURI"
    AudioSource="-f $AudioFormat -i $AudioSourceURI"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    #VideoConfig="-filter_complex realtime,scale=$scale,format=yuv420p"
    VideoConfig="-vf realtime,scale=$scale,format=yuv420p,drawtext=textfile='$OverlaySourceURI':x=50:y=50:fontsize=24:fontcolor=white:reload=1"
    AudioConfig="-c:a aac -ar 48000 -b:a 128k"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    OutputConfig="-r $fps -g $gop -c:v libx264 -preset ultrafast -tune zerolatency"; #-profile:v baseline"
###############################################################################################################################################
}

function overlay(){
###############################################################################################################################################
    touch "$data/OverlayText.txt"
    sleep 1
    while [ -n "$(pidof ffmpeg)" ]; do
        echo "Now playing: $(mpc current)" > "$data/OverlayText.txt"
        mpc current -w > /dev/null
    done
###############################################################################################################################################
}

function stream() { 
###############################################################################################################################################
    checkvars
    ffmpeg=$(which ffmpeg)
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    mkdir -p "$logs"
    echo "$$" > "$pidfile"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    $ffmpeg -hide_banner -stream_loop -1 $VideoSource -thread_queue_size 1024 $AudioSource $VideoConfig \
    $OutputConfig $AudioConfig -f flv $OutputURL/$OutputKey |& tee -a "$logs/ffstream.$now.log"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    rm "$pidfile"
###############################################################################################################################################
}

function checkvars(){
###############################################################################################################################################
    fail="no"
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    if [ ! -n "$VideoSourceURI" ]; then echo "VideoSourceURI is not set!"; fail="yes"; fi
    if [ ! -n "$AudioSourceURI" ]; then echo "AudioSourceURI is not set!"; fail="yes"; fi
    if [ ! -n "$OverlaySourceURI" ]; then echo "OverlaySourceURI is not set!"; fail="yes"; fi
    if [ ! -n "$OutputURL" ]; then echo "OutputURL is not set!"; fail="yes"; fi
    if [ ! -n "$OutputKey" ]; then echo "OutputKey is not set!"; fail="yes"; fi
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    if [ $fail == "yes" ]; then echo "Can't start streaming"; exit 1; fi
###############################################################################################################################################
}



runtime="$(realpath "$0")"

bin="$(realpath "$0")"
bin="${bin%/*}"

data="$(realpath "$bin/../data")"
logs="$(realpath "$bin/../logs")"
cd "$data"

pidfile="$bin/ffstream.pid"
now=$(date +"%F.%H-%M-%S")

checkdeps


##############################################################################################################################################

    if [ -n "$1" -a -z "$2" ]; then

#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#

#//!        # If started with arg --heartbeat, init heartbeat function #
#//!        if [ $1 == "--stream" ]; then
#//!            setup-stream
#//!            stream
#//!            exit
#//!        fi
#//!
#//!#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
#//!
#//!        # If started with arg --overlay, init overlay function #
#//!        if [ $1 == "--overlay" ]; then
#//!    	    configs
#//!            overlay
#//!            exit
#//!        fi
    
        # If started with arg --refresh-overlay, refresh overlay text #
        if [ $1 == "--refresh-overlay" ]; then
            echo "Now playing: $(mpc current)" > "$data/OverlayText.txt"
            exit
        fi

        exit
    fi
#=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=#
    
    if [ ! -n "$(pidof ffmpeg)" ]; then
        configs
        overlay &
        setup-stream
        stream
    fi

###############################################################################################################################################

exit